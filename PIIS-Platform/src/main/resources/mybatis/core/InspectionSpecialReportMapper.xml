<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="tech.piis.modules.core.mapper.InspectionSpecialReportMapper">

    <resultMap type="InspectionSpecialReportPO" id="InspectionSpecialReportResult">
        <result property="specialReportId" column="SPECIAL_REPORT_ID"/>
        <result property="planId" column="PLAN_ID"/>
        <result property="reportName" column="REPORT_NAME"/>
        <result property="reportTime" column="REPORT_TIME"/>
        <result property="venue" column="VENUE"/>
        <result property="reporterName" column="REPORTER_NAME"/>
        <result property="reporterId" column="REPORTER_ID"/>
        <result property="inspectionGroupPersonName" column="INSPECTION_GROUP_PERSON_NAME"/>
        <result property="inspectionGroupPersonId" column="INSPECTION_GROUP_PERSON_ID"/>
        <result property="reportPersonName" column="REPORT_PERSON_NAME"/>
        <result property="reportPersonId" column="REPORT_PERSON_ID"/>
        <result property="meetingDesc" column="MEETING_DESC"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="createdTime" column="CREATED_TIME"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="updatedTime" column="UPDATED_TIME"/>
        <result property="entId" column="ENT_ID"/>
    </resultMap>

    <resultMap id="unitsBizCountResultMap" type="UnitsBizCountVO">
        <result property="unitsId" column="units_id"/>
        <result property="orgId" column="org_id"/>
        <result property="orgName" column="org_name"/>
        <result property="count" column="count"/>
    </resultMap>

    <sql id="selectInspectionSpecialReportVo">
        select SPECIAL_REPORT_ID, PLAN_ID, REPORT_NAME, REPORT_TIME, VENUE, REPORTER_NAME, REPORTER_ID, INSPECTION_GROUP_PERSON_NAME, INSPECTION_GROUP_PERSON_ID, REPORT_PERSON_NAME, REPORT_PERSON_ID, MEETING_DESC, CREATED_BY, CREATED_TIME, UPDATED_BY, UPDATED_TIME, ENT_ID from inspection_special_report
    </sql>

    <select id="selectInspectionSpecialReportList" parameterType="InspectionSpecialReportPO"
            resultMap="InspectionSpecialReportResult">
        <include refid="selectInspectionSpecialReportVo"/>
        <where>
            <if test="planId != null  and planId != ''">and PLAN_ID = #{planId}</if>
            <if test="reportName != null  and reportName != ''">and REPORT_NAME like concat('%', #{reportName}, '%')
            </if>
            <if test="reportTime != null ">and REPORT_TIME = #{reportTime}</if>
            <if test="venue != null  and venue != ''">and VENUE = #{venue}</if>
            <if test="reporterName != null  and reporterName != ''">and REPORTER_NAME like concat('%', #{reporterName},
                '%')
            </if>
            <if test="reporterId != null  and reporterId != ''">and REPORTER_ID = #{reporterId}</if>
            <if test="inspectionGroupPersonName != null  and inspectionGroupPersonName != ''">and
                INSPECTION_GROUP_PERSON_NAME like concat('%', #{inspectionGroupPersonName}, '%')
            </if>
            <if test="inspectionGroupPersonId != null  and inspectionGroupPersonId != ''">and INSPECTION_GROUP_PERSON_ID
                = #{inspectionGroupPersonId}
            </if>
            <if test="reportPersonName != null  and reportPersonName != ''">and REPORT_PERSON_NAME like concat('%',
                #{reportPersonName}, '%')
            </if>
            <if test="reportPersonId != null  and reportPersonId != ''">and REPORT_PERSON_ID = #{reportPersonId}</if>
            <if test="meetingDesc != null  and meetingDesc != ''">and MEETING_DESC = #{meetingDesc}</if>
            <if test="createdBy != null  and createdBy != ''">and CREATED_BY = #{createdBy}</if>
            <if test="createdTime != null ">and CREATED_TIME = #{createdTime}</if>
            <if test="updatedBy != null  and updatedBy != ''">and UPDATED_BY = #{updatedBy}</if>
            <if test="updatedTime != null ">and UPDATED_TIME = #{updatedTime}</if>
            <if test="entId != null  and entId != ''">and ENT_ID = #{entId}</if>
        </where>
    </select>

    <select id="selectSpecialReportCount" resultMap="unitsBizCountResultMap" parameterType="java.lang.String">
        select u.UNITS_ID,u.ORG_ID,u.ORG_NAME,count(r.UNITS_ID) as count
        from inspection_units u
        left join inspection_special_report r on u.UNITS_ID = r.UNITS_ID
        where u.plan_id = #{planId}
        group by u.UNITS_ID
        order by count desc
    </select>

</mapper>