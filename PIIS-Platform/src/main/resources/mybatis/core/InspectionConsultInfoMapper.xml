<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="tech.piis.modules.core.mapper.InspectionConsultInfoMapper">

    <resultMap type="InspectionConsultInfoPO" id="InspectionConsultInfoResult">
        <result property="consultInfoId" column="CONSULT_INFO_ID"/>
        <result property="unitsId" column="UNITS_ID"/>
        <result property="planId" column="PLAN_ID"/>
        <result property="signFlag" column="SIGN_FLAG"/>
        <result property="signTime" column="SIGN_TIME"/>
        <result property="checkPersonId" column="CHECK_PERSON_ID"/>
        <result property="checkPersonName" column="CHECK_PERSON_NAME"/>
        <result property="consultContent" column="CONSULT_CONTENT"/>
        <result property="checkTime" column="CHECK_TIME"/>
        <result property="createdBy" column="CREATED_BY"/>
        <result property="createdTime" column="CREATED_TIME"/>
        <result property="updatedBy" column="UPDATED_BY"/>
        <result property="updatedTime" column="UPDATED_TIME"/>
        <result property="entId" column="ENT_ID"/>

        <collection property="consultInfoDetailList" javaType="java.util.List"
                    resultMap="consultInfoDetailResultMap"/>
    </resultMap>

    <resultMap id="consultInfoDetailResultMap" type="InspectionConsultInfoDetailPO">
        <id property="consultInfoDetailId" column="CONSULT_INFO_DETAIL_ID"/>
        <!--<result property="consultInfoId" column="CONSULT_INFO_ID"/>-->
        <result property="checkInfoName" column="CHECK_INFO_NAME"/>
        <result property="checkInfoCount" column="CHECK_INFO_COUNT"/>
        <result property="checkInfoMaterialType" column="CHECK_INFO_MATERIAL_TYPE"/>
        <result property="checkInfoOriginType" column="CHECK_INFO_ORIGIN_TYPE"/>
        <result property="timeLimit" column="TIME_LIMIT"/>
        <result property="providerId" column="PROVIDER_ID"/>
        <result property="providerName" column="PROVIDER_NAME"/>
        <result property="providerTime" column="PROVIDER_TIME"/>
        <result property="returnStatus" column="RETURN_STATUS"/>
        <result property="returnPersonId" column="RETURN_PERSON_ID"/>
        <result property="returnPersonName" column="RETURN_PERSON_NAME"/>
        <result property="returnTime" column="RETURN_TIME"/>
    </resultMap>

    <resultMap id="unitsBizCountResultMap" type="UnitsBizCountVO">
        <result property="unitsId" column="units_id"/>
        <result property="orgId" column="org_id"/>
        <result property="orgName" column="org_name"/>
        <result property="count" column="count"/>
        <result property="createdTime" column="CREATED_TIME"/>
    </resultMap>


    <select id="selectInspectionConsultInfoList" parameterType="InspectionConsultInfoPO"
            resultMap="InspectionConsultInfoResult">
        select
          c.CONSULT_INFO_ID,
          c.PLAN_ID,
          c.SIGN_FLAG,
          c.SIGN_TIME,
          c.CHECK_PERSON_ID,
          c.CHECK_PERSON_NAME,
          c.CONSULT_CONTENT,
          c.CHECK_TIME,
          c.CREATED_BY,
          c.CREATED_TIME,
          c.UPDATED_BY,
          c.UPDATED_TIME,
          c.ENT_ID,
          d.CONSULT_INFO_DETAIL_ID,
          d.CHECK_INFO_NAME,
          d.CHECK_INFO_COUNT,
          d.CHECK_INFO_MATERIAL_TYPE,
          d.CHECK_INFO_ORIGIN_TYPE,
          d.TIME_LIMIT,
          d.PROVIDER_ID,
          d.PROVIDER_NAME,
          d.PROVIDER_TIME,
          d.RETURN_STATUS,
          d.RETURN_PERSON_ID,
          d.RETURN_PERSON_NAME,
          d.RETURN_TIME
      from (
         select
             CONSULT_INFO_ID,
             PLAN_ID,
             SIGN_FLAG,
             SIGN_TIME,
             CHECK_PERSON_ID,
             CHECK_PERSON_NAME,
             CHECK_TIME,
             CONSULT_CONTENT,
             CREATED_BY,
             CREATED_TIME,
             UPDATED_BY,
             UPDATED_TIME,
             ENT_ID
       from inspection_consult_info
       where PLAN_ID =#{planId}
             and UNITS_ID = #{unitsId}
       limit #{pageNum},#{pageSize}
     ) c
      left join inspection_consult_info_detail d on c.CONSULT_INFO_ID = d.CONSULT_INFO_ID
      order by c.CREATED_TIME desc
    </select>

    <select id="selectInspectionConsultInfoCount" parameterType="java.lang.String" resultMap="unitsBizCountResultMap">
        select u.UNITS_ID,u.ORG_ID,u.ORG_NAME,u.created_time, count(d.UNITS_ID) as count
        from inspection_units u
        left join inspection_consult_info d on u.UNITS_ID = d.UNITS_ID
        where u.plan_id = #{planId}
        group by u.UNITS_ID
        order by u.created_time desc
    </select>

</mapper>